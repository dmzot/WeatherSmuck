function fetchError(n){if(typeof n=="string"||n instanceof String)var t=n;else t=n.message;$("#alert > p")[0].innerHTML=t;$("#alert").show()}function startWebSockets(){ws.start().catch(fetchError)}function getAddress(n){placemark.properties.set("iconCaption","поиск...");ymaps.geocode(n).then(function(n){let t=n.geoObjects.get(0);placemark.properties.set({iconCaption:[t.getLocalities().length?t.getLocalities():t.getAdministrativeAreas(),t.getThoroughfare()||t.getPremise()].filter(Boolean).join(", "),balloonContent:t.getAddressLine()});$("#addr")[0].innerText=placemark.properties.get("iconCaption")})}const ws=(new signalR.HubConnectionBuilder).withUrl("/weather",{transport:signalR.HttpTransportType.WebSockets}).withAutomaticReconnect().configureLogging(signalR.LogLevel.Warning).build();let map,placemark;var getCoordinates=function(n){n.length>0&&ymaps.geocode(n,{results:1}).then(n=>{let t=n.geoObjects.get(0),i=t.geometry.getCoordinates(),u=t.properties.get("boundedBy");placemark?placemark.geometry.setCoordinates(i):(placemark=t,placemark.options.set("preset","islands#darkBlueDotIconWithCaption"),map.geoObjects.add(placemark));let r=t.getAddressLine();placemark.properties.set("iconCaption",r);map.setBounds(u,{checkZoomRange:!0});$("#addr")[0].innerText=r;getWeather(i)})},getWeather=function(n){let t={lat:n[0],lon:n[1]};ws.invoke("GetCurrentWeather",t).then(n=>{if(n.errorMessage!==undefined&&n.errorMessage!==null){fetchError(n.errorMessage);return}if(n.weather===undefined||n.weather.length===0){fetchError("Ooops. Smth went wrong. We'll fix it soon.");return}let t=JSON.parse(n.weather);setWeather(t)}).catch(fetchError)},setWeather=function(n){if(n.cod!==200){fetchError("Something went wrong with OpenWeatherAPI: "+n.message);return}if($("#weather_div").show(),n.clouds.all!==undefined&&($("#dcloudness").show(),$("#cloudness")[0].innerText=n.clouds.all+"%"),n.wind.speed!==undefined&&($("#dwind").show(),$("#wind")[0].innerText=n.wind.speed+" m/sec"),n.main.temp!==undefined&&($("#dtemp").show(),$("#temp")[0].innerText="Now: "+n.main.temp+" C",$("#temp_max")[0].innerText="Max: "+n.main.temp_max+" C",$("#temp_min")[0].innerText="Min: "+n.main.temp_min+" C",$("#feels_like")[0].innerText="Feels: "+n.main.feels_like+" C"),n.main.humidity!==undefined&&($("#dhumidity").show(),$("#humidity")[0].innerText=n.main.humidity+"%"),n.weather.length){let t=n.weather[0].icon;$("#dicon").show();$("#icon").attr("class","owi owi-"+t)}console.log(n)},addPlacemark=function(n){placemark?placemark.geometry.setCoordinates(n):(placemark=new ymaps.Placemark(n,{iconCaption:"searching..."},{preset:"islands#darkBlueDotIconWithCaption",draggable:!0}),map.geoObjects.add(placemark),placemark.events.add("dragend",function(){getAddress(placemark.geometry.getCoordinates())}))};ymaps.ready(()=>{map=new ymaps.Map("map",{center:[55.76,37.64],zoom:10,controls:["zoomControl","fullscreenControl","geolocationControl"]});map.events.add("click",function(n){let t=n.get("coords");addPlacemark(t);getAddress(t);getWeather(t)});var t=new ymaps.SuggestView("address",{results:4,provider:{suggest:function(n){return ymaps.suggest("Moscow, "+n)}}});t.events.add("select",n=>{var t=n.get("item").value;getCoordinates(t)});let n=$("#address").val();n.length>0&&getCoordinates(n)});$(document).ready(()=>{$("#address").on("keypress",function(n){const t=n.keyCode||n.which;t===13&&(n.preventDefault(),n.stopPropagation(),getCoordinates($(this).val()))});$("#address").focus();startWebSockets()});